#!/usr/bin/env python3
"""
Cleanup script - Uninstall brew packages that are installed via apt.
Run periodically when migrating packages from brew to apt.
"""

import argparse
import subprocess
import sys
import tomllib
from pathlib import Path


def load_package_mapping() -> dict:
    """Load package mapping from TOML file."""
    mapping_file = Path.home() / ".config/packages/package-mapping.toml"
    if not mapping_file.exists():
        print(f"Warning: {mapping_file} not found, using empty mapping")
        return {}

    with open(mapping_file, "rb") as f:
        return tomllib.load(f)


def is_apt_installed(package: str) -> bool:
    """Check if package is installed via apt."""
    result = subprocess.run(
        ["dpkg", "-s", package],
        capture_output=True,
    )
    return result.returncode == 0


def is_brew_installed(package: str) -> bool:
    """Check if package is installed via brew."""
    result = subprocess.run(
        ["brew", "list", package],
        capture_output=True,
    )
    return result.returncode == 0


def uninstall_brew(package: str) -> bool:
    """Uninstall package from brew."""
    result = subprocess.run(
        ["brew", "uninstall", package],
        capture_output=True,
    )
    return result.returncode == 0


def main():
    parser = argparse.ArgumentParser(
        description="Cleanup brew packages that are installed via apt"
    )
    parser.add_argument(
        "-n", "--dry-run",
        action="store_true",
        help="Show what would be uninstalled without making changes"
    )
    parser.add_argument(
        "-v", "--verbose",
        action="store_true",
        help="Show detailed output"
    )
    args = parser.parse_args()

    # Check if we're on Linux
    import platform
    if platform.system() != "Linux":
        print("This script is intended for Linux only")
        sys.exit(0)

    # Check if apt is available
    if subprocess.run(["which", "apt"], capture_output=True).returncode != 0:
        print("apt not found")
        sys.exit(1)

    # Check if brew is available
    if subprocess.run(["which", "brew"], capture_output=True).returncode != 0:
        print("brew not found, nothing to clean up")
        sys.exit(0)

    # Load package mapping
    mapping = load_package_mapping()

    if not mapping:
        print("No package mapping found")
        sys.exit(1)

    print("Checking for brew packages that should be installed via apt...")
    print()

    to_uninstall = []

    for name, pkg in mapping.items():
        brew_name = pkg.get("brew", name)
        apt_name = pkg.get("apt", name)

        apt_installed = is_apt_installed(apt_name)
        brew_installed = is_brew_installed(brew_name)

        if args.verbose:
            print(f"{name}: apt({apt_name})={apt_installed}, brew({brew_name})={brew_installed}")

        # If both are installed, mark for uninstall from brew
        if apt_installed and brew_installed:
            to_uninstall.append((name, brew_name, apt_name))
            print(f"  [DUPLICATE] {name}: brew({brew_name}) and apt({apt_name})")

    print()

    if not to_uninstall:
        print("No duplicates found. Nothing to clean up.")
        sys.exit(0)

    print(f"Found {len(to_uninstall)} duplicate(s)")
    print()

    if args.dry_run:
        print("[DRY RUN] Would uninstall from brew:")
        for name, brew_name, _ in to_uninstall:
            print(f"  brew uninstall {brew_name}")
    else:
        confirm = input("Uninstall these packages from brew? (y/N): ")
        if confirm.lower() == "y":
            for name, brew_name, _ in to_uninstall:
                print(f"Uninstalling {brew_name} from brew...")
                if not uninstall_brew(brew_name):
                    print(f"  Warning: Failed to uninstall {brew_name}")
            print()
            print("Cleanup complete!")
        else:
            print("Cancelled")


if __name__ == "__main__":
    main()
