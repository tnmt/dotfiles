#!/bin/bash

# Install packages based on OS and available package managers
set -e

OS="$(uname -s)"

# Install Homebrew if not installed
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    if [ "$OS" = "Linux" ]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    elif [ "$OS" = "Darwin" ]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
fi

# Install packages with Homebrew
if command -v brew &> /dev/null; then
    echo "Installing packages with Homebrew..."
    brew bundle --file=~/.config/packages/brewfile
fi


# Linux-specific packages (using native package manager)
{{ if eq .chezmoi.os "linux" -}}
if command -v apt &> /dev/null; then
    echo "Installing Linux packages with apt..."
    sudo apt update
    sudo apt install -y \
        build-essential \
        software-properties-common \
        zsh \
        fonts-powerline \
        fonts-firacode
elif command -v dnf &> /dev/null; then
    echo "Installing Linux packages with dnf..."
    sudo dnf install -y \
        gcc \
        gcc-c++ \
        make \
        zsh \
        powerline-fonts \
        fira-code-fonts
elif command -v pacman &> /dev/null; then
    echo "Installing Linux packages with pacman..."
    sudo pacman -S --noconfirm \
        base-devel \
        zsh \
        powerline-fonts \
        ttf-fira-code
fi
{{ end -}}

# Desktop-specific packages
{{ if .desktop -}}
echo "Installing desktop applications..."

{{ if eq .chezmoi.os "linux" -}}
# Linux desktop apps
if command -v flatpak &> /dev/null; then
    flatpak install -y flathub \
        com.visualstudio.code \
        com.slack.Slack
fi
{{ end -}}

{{ if eq .chezmoi.os "darwin" -}}
# macOS desktop apps
brew install --cask \
    alacritty
{{ end -}}
{{ end -}}

# Install mise (development tool version manager)
if ! command -v mise &> /dev/null; then
    echo "Installing mise..."
    curl https://mise.run | sh
    if [ -f "$HOME/.config/zsh/.zshrc" ] && ! grep -q 'mise activate zsh' "$HOME/.config/zsh/.zshrc"; then
        echo 'eval "$(~/.local/bin/mise activate zsh)"' >> "$HOME/.config/zsh/.zshrc"
    fi
fi

# Setup mise tools without overriding existing config
if command -v mise &> /dev/null; then
    mkdir -p "$HOME/.config/mise"
    if [ -f "$HOME/.config/mise/config.toml" ]; then
        mise install
    else
        cat >"$HOME/.config/mise/config.toml" <<'EOF'
{{ includeTemplate "dot_config/mise/config.toml" . -}}
EOF
        mise install
    fi
fi

echo "Package installation completed!"
