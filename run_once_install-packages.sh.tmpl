#!/bin/bash

# Install packages based on OS and available package managers
set -e

OS="$(uname -s)"

# Install Homebrew if not installed
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    if [ "$OS" = "Linux" ]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.zprofile
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    elif [ "$OS" = "Darwin" ]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
fi

# Install packages with Homebrew
if command -v brew &> /dev/null; then
    echo "Installing packages with Homebrew..."
    brew bundle --file=~/.config/packages/brewfile
fi

# Install mise (development tool version manager)
if ! command -v mise &> /dev/null; then
    echo "Installing mise..."
    curl https://mise.run | sh
    echo 'eval "$(~/.local/bin/mise activate zsh)"' >> ~/.zshrc
fi

# Setup mise tools
if command -v mise &> /dev/null; then
    mise use --global node@latest
    mise use --global python@latest
fi

# Linux-specific packages (using native package manager)
{{ if eq .chezmoi.os "linux" -}}
if command -v apt &> /dev/null; then
    echo "Installing Linux packages with apt..."
    sudo apt update
    sudo apt install -y \
        build-essential \
        software-properties-common \
        zsh \
        fonts-powerline \
        fonts-firacode
elif command -v dnf &> /dev/null; then
    echo "Installing Linux packages with dnf..."
    sudo dnf install -y \
        gcc \
        gcc-c++ \
        make \
        zsh \
        powerline-fonts \
        fira-code-fonts
elif command -v pacman &> /dev/null; then
    echo "Installing Linux packages with pacman..."
    sudo pacman -S --noconfirm \
        base-devel \
        zsh \
        powerline-fonts \
        ttf-fira-code
fi
{{ end -}}

# Desktop-specific packages
{{ if .desktop -}}
echo "Installing desktop applications..."

{{ if eq .chezmoi.os "linux" -}}
# Linux desktop apps
if command -v flatpak &> /dev/null; then
    flatpak install -y flathub \
        com.google.Chrome \
        org.mozilla.firefox \
        com.visualstudio.code \
        com.slack.Slack
fi
{{ end -}}

{{ if eq .chezmoi.os "darwin" -}}
# macOS desktop apps
brew install --cask \
    google-chrome \
    firefox \
    visual-studio-code \
    slack \
    iterm2 \
    rectangle
{{ end -}}
{{ end -}}

echo "Package installation completed!"