{{ if not .minimal -}}
#!/bin/bash

# Setup Neovim
set -e

STATE_FILE="$HOME/.local/state/nvim/setup.done"
if [ -f "$STATE_FILE" ]; then
    echo "Neovim setup already complete. Skipping."
    exit 0
fi

echo "Setting up Neovim..."

# Create backup directory for vim
mkdir -p ~/.vimbackup

# Install Neovim if not installed (always use brew for latest version)
if ! command -v nvim &> /dev/null; then
    echo "Installing Neovim..."
    if command -v brew &> /dev/null; then
        brew install neovim
    else
        echo "Please install Homebrew first, then run: brew install neovim"
        exit 1
    fi
fi

# Install dependencies for Neovim
echo "Installing Neovim dependencies..."

# Python support
if command -v pip3 &> /dev/null; then
    pip3 install --user pynvim
fi

# Node support  
if command -v npm &> /dev/null; then
    npm install -g neovim
fi

# Ruby support
if command -v gem &> /dev/null; then
    gem install neovim
    gem install rubocop
    gem install ruby-lsp
fi

# Install language servers and tools
echo "Installing language servers and development tools..."

# Install ripgrep and fd for Telescope
if command -v brew &> /dev/null; then
    brew install ripgrep fd
elif command -v apt &> /dev/null; then
    sudo apt install -y ripgrep fd-find
fi

# Install formatters and linters
if command -v pip3 &> /dev/null; then
    pip3 install --user black flake8 pylint
fi

if command -v npm &> /dev/null; then
    npm install -g prettier eslint typescript typescript-language-server
fi

if command -v go &> /dev/null; then
    go install golang.org/x/tools/gopls@latest
    go install golang.org/x/tools/cmd/goimports@latest
fi

echo "Neovim setup completed!"
echo "Run 'nvim' and lazy.nvim will automatically install plugins on first launch."

mkdir -p "$(dirname "$STATE_FILE")"
touch "$STATE_FILE"
{{ end -}}
